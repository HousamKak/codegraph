direction: right

# Main Components
llm: LLM (Claude, GPT, etc.) {
  shape: hexagon
  style.fill: "#E8F5E9"
  style.stroke: "#4CAF50"
}

mcp_server: MCP Server (13 Read-Only Tools) {
  shape: rectangle
  style.fill: "#E3F2FD"
  style.stroke: "#2196F3"
}

mcp_server.indexing: Indexing Tools {
  shape: rectangle
  style.fill: "#BBDEFB"
}
mcp_server.indexing.tool1: index_codebase
mcp_server.indexing.tool2: get_graph_stats

mcp_server.querying: Querying Tools {
  shape: rectangle
  style.fill: "#BBDEFB"
}
mcp_server.querying.tool1: find_function
mcp_server.querying.tool2: get_function_details
mcp_server.querying.tool3: get_function_callers
mcp_server.querying.tool4: get_function_callees
mcp_server.querying.tool5: get_function_dependencies
mcp_server.querying.tool6: search_code

mcp_server.analysis: Analysis Tools {
  shape: rectangle
  style.fill: "#BBDEFB"
}
mcp_server.analysis.tool1: analyze_impact
mcp_server.analysis.tool2: validate_codebase

mcp_server.snapshots: Snapshot Tools {
  shape: rectangle
  style.fill: "#BBDEFB"
}
mcp_server.snapshots.tool1: create_snapshot
mcp_server.snapshots.tool2: compare_snapshots
mcp_server.snapshots.tool3: list_snapshots

fastapi: FastAPI Backend {
  shape: rectangle
  style.fill: "#FFF3E0"
  style.stroke: "#FF9800"
}

neo4j: Neo4j Graph Database {
  shape: cylinder
  style.fill: "#F3E5F5"
  style.stroke: "#9C27B0"
}

neo4j.nodes: Graph Nodes {
  shape: rectangle
  style.fill: "#E1BEE7"
}
neo4j.nodes.func: Function (14 nodes)
neo4j.nodes.param: Parameter (15 nodes)
neo4j.nodes.class: Class
neo4j.nodes.var: Variable

neo4j.rels: Relationships {
  shape: rectangle
  style.fill: "#E1BEE7"
}
neo4j.rels.calls: CALLS (with location, arg_count)
neo4j.rels.has_param: HAS_PARAMETER (with position)
neo4j.rels.defines: DEFINES
neo4j.rels.refs: REFERENCES

# Core Components
parser: Python AST Parser {
  shape: rectangle
  style.fill: "#FCE4EC"
}

builder: Graph Builder {
  shape: rectangle
  style.fill: "#FCE4EC"
}

validator: Conservation Validator {
  shape: rectangle
  style.fill: "#FCE4EC"
}

validator.law1: 1. Signature Conservation
validator.law2: 2. Reference Integrity
validator.law3: 3. Data Flow Consistency
validator.law4: 4. Structural Integrity

snapshot_mgr: Snapshot Manager {
  shape: rectangle
  style.fill: "#FCE4EC"
}

# Workflow Steps
workflow: LLM Workflow {
  shape: rectangle
  style.fill: "#FFFDE7"
  style.stroke: "#FBC02D"
  style.stroke-width: 3
}

workflow.step1: 1. LLM edits code {
  shape: rectangle
  style.fill: "#FFF9C4"
}

workflow.step2: 2. Call index_codebase {
  shape: rectangle
  style.fill: "#FFF59D"
}

workflow.step3: 3. Call create_snapshot {
  shape: rectangle
  style.fill: "#FFF176"
}

workflow.step4: 4. Call compare_snapshots {
  shape: rectangle
  style.fill: "#FFEE58"
}

workflow.step5: 5. Call validate_codebase {
  shape: rectangle
  style.fill: "#FFEB3B"
}

workflow.step6: 6. LLM reviews violations {
  shape: rectangle
  style.fill: "#FDD835"
}

workflow.step7: 7. LLM fixes code {
  shape: rectangle
  style.fill: "#FBC02D"
}

# Connections
llm -> mcp_server: MCP Protocol (stdio) {
  style.stroke: "#4CAF50"
  style.stroke-width: 3
}

llm -> workflow.step1: Executes workflow

workflow.step1 -> workflow.step2
workflow.step2 -> workflow.step3
workflow.step3 -> workflow.step4
workflow.step4 -> workflow.step5
workflow.step5 -> workflow.step6
workflow.step6 -> workflow.step7
workflow.step7 -> workflow.step1: Repeat until clean {
  style.stroke-dash: 3
}

mcp_server.indexing -> parser: parse code
parser -> builder: entities + relationships
builder -> neo4j: MERGE nodes

mcp_server.querying -> neo4j: Cypher queries

mcp_server.analysis -> validator: check laws
validator -> neo4j: query graph

mcp_server.snapshots -> snapshot_mgr: manage snapshots
snapshot_mgr -> neo4j: capture state

fastapi -> parser: same components
fastapi -> neo4j: same database

# Key Features
features: Key Features {
  shape: rectangle
  style.fill: "#E0F7FA"
  style.stroke: "#00BCD4"
}

features.f1: Read-only analysis
features.f2: Snapshot comparison
features.f3: Smart parameter counting
features.f4: Clean re-indexing
features.f5: Exact violation locations
features.f6: Code snippets with context

# Example Violation
example: Example Violation {
  shape: rectangle
  style.fill: "#FFEBEE"
  style.stroke: "#F44336"
}

example.error: ERROR Signature Mismatch {
  shape: rectangle
  style.fill: "#FFCDD2"
}
example.func: Function calculate_total
example.expected: expects 2 arguments
example.actual: called with 1
example.location: file line 65 column 12
example.fix: Provide 2 arguments
